cost function:
  cost type: 3D-Var
  time window:
    begin: '{{ WINDOW_BEGIN | to_isotime }}'
    length: 'PT{{assim_freq}}H'
  analysis variables:
  - volume_mixing_ratio_of_no2
  geometry:
    fms initialization:
      namelist filename: '{{NCO_DIR}}/Data/fv3files/fmsmpp.nml'
      field table filename: '{{NCO_DIR}}/Data/fv3files/field_table_lam_cmaq'
    namelist filename: '{{NCO_DIR}}/Data/fv3files/input_lam_cmaq.nml'
    akbk: '{{NCO_DIR}}/Data/fv3files/akbk64.nc4'
    field metadata override: '{{NCO_DIR}}/Data/fieldmetadata/lam_cmaq.yaml'
  background:
    datetime: '{{ CURRENT_CYCLE | to_isotime }}'
    filetype: fms restart
    datapath: '{{PREV_CYCLE_DIR}}/RESTART'
    filename_core: '{{ CURRENT_CYCLE | to_fv3time }}.fv_core.res.tile1.nc'
    filename_trcr: '{{ CURRENT_CYCLE | to_fv3time }}.fv_tracer.res.tile1.nc'
    filename_cplr: '{{ CURRENT_CYCLE | to_fv3time }}.coupler.res'
    state variables:
    - u
    - v
    - T
    - DELP
    - phis
    - volume_mixing_ratio_of_no2
  background error:
    covariance model: SABER
    saber central block:
      saber block name: diffusion
      read:
        groups:
        - variables: [volume_mixing_ratio_of_no2]
          horizontal:
#           filepath: '{{NCO_DIR}}/Data/diffusion/{{ CURRENT_CYCLE | to_YMD }}.diffusion_hz'
            filepath: '{{EXPTDIR}}/Data/diffusion/{{ CURRENT_CYCLE | to_YMD }}.diffusion_hz'
          vertical:
            levels: 64
#           filepath: '{{NCO_DIR}}/Data/diffusion/{{ CURRENT_CYCLE | to_YMD }}.diffusion_vt'
            filepath: '{{EXPTDIR}}/Data/diffusion/{{ CURRENT_CYCLE | to_YMD }}.diffusion_vt'
    saber outer blocks:
    - saber block name: StdDev
      read:
        model file:
          datetime: '{{ CURRENT_CYCLE | to_isotime }}'
          skip coupler file: true
          filetype: fms restart
          psinfile: true
#         datapath: '{{NCO_DIR}}/Data/staticb_tracer/DiagB'
          datapath: '{{EXPTDIR}}/Data/diagb_tracer'
          filename_core: '{{ CURRENT_CYCLE | to_fv3time }}.stddev.fv_core.res.nc'
          filename_trcr: '{{ CURRENT_CYCLE | to_fv3time }}.stddev.fv_tracer.res.nc'
          filename_cplr: '{{ CURRENT_CYCLE | to_fv3time }}.stddev.coupler.res'
  observations:
    observers:
    - obs space:
        name: NO2
        obsdatain:
          engine:
            type: H5File
            obsfile: '{{NCO_DIR}}/Data/obs/testinput_tier_1/qa75/{{ CURRENT_CYCLE | to_YMD }}.tropomi_no2_tropo_CONUS.nc4'
        obsdataout:
          engine:
            type: H5File
            #obsfile: '{{NCO_DIR}}/Data/hofx/{{ CURRENT_CYCLE | to_YMD }}.tropomi_no2_3dvar_lam_cmaq.nc4'
            obsfile: '{{EXPTDIR}}/Data/hofx/{{ CURRENT_CYCLE | to_YMD }}.tropomi_no2_3dvar_lam_cmaq.nc4'
        simulated variables:
        - nitrogendioxideColumn
      obs filters:
      - filter: Domain Check
        where:
        - variable:
            name: MetaData/quality_assurance_value
#### NO DA #################
#      - filter: BlackList
#        action:
#          name: passivate
#        where:
#          - variable:
#              name: MetaData/latitude
#        minvalue: 180
#        maxvalue: 180
############################
      obs operator:
        name: ColumnRetrieval
        nlayers_retrieval: 34
        tracer variables:
        - volume_mixing_ratio_of_no2
        stretchVertices: topbottom
        isApriori: false
        isAveragingKernel: true
        model units coeff: 1e-6
      obs error:
        covariance model: diagonal
variational:
  minimizer:
    algorithm: PCG
  iterations:
  - ninner: 10
    gradient norm reduction: 1e-10
    test: true
    geometry:
      namelist filename: '{{NCO_DIR}}/Data/fv3files/input_lam_cmaq.nml'
      akbk: '{{NCO_DIR}}/Data/fv3files/akbk64.nc4'
      field metadata override: '{{NCO_DIR}}/Data/fieldmetadata/lam_cmaq.yaml'
    diagnostics:
      departures: ombg
final:
  diagnostics:
    departures: oman
output:
  filetype: fms restart
  #datapath: '{{NCO_DIR}}/Data/analysis'
  datapath: '{{EXPTDIR}}/Data/analysis'
  filename_core: '3dvar_lam_cmaq_no2.fv_core.res.nc'
  filename_trcr: '3dvar_lam_cmaq_no2.fv_tracer.res.nc'
  filename_cplr: '3dvar_lam_cmaq_no2.coupler.res'
  frequency: PT1H
